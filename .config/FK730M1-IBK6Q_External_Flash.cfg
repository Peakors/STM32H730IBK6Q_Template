# SPDX-License-Identifier: GPL-2.0-or-later

# This is a FK730M1-IBK6Q with a single STM32H730IBK6Q chip.
# https://item.taobao.com/item.htm?id=704335255620
# QQ交流群：536665479
# Made by Peakors

# This is for using the STLINK
source [find interface/stlink.cfg]

transport select hla_swd

set CHIPNAME STM32H730IBK6Q

# enable stmqspi
if {![info exists OCTOSPI2]} {
	set OCTOSPI1 0
	set OCTOSPI2 1
}

source [find target/stm32h7x.cfg]

reset_config srst_only

# OCTOSPI initialization
# octo: 4-line mode
# NCS: PG12, CLK: PF00, IO3/NHOLD: PF01, IO2/NWP: PF02, IO1/MISO: PF03, IO0/MOSI: PF04
proc octospi_init { octo } {
	global a b
	mmw 0x58024540 0x000006FF 0				;# RCC_AHB4ENR |= GPIOAEN-GPIOKEN (enable clocks)
	mmw 0x58024534 0x00284000 0				;# RCC_AHB3ENR |= IOMNGREN, OSPI2EN, OSPI1EN (enable clocks)
	sleep 1									;# Wait for clock startup

	mww 0x5200B404 0x00000000				;# OCTOSPIM_P1CR: disable Port 1
	mww 0x5200B408 0x04050323				;# OCTOSPIM_P2CR: assign Port 2 to OCTOSPI2
	
	
	# perl gpio_conf_stm32.pl -b 0x58020000 -c "PG12:AF3:V, PF0:AF9:V, PF1:AF9:V, PF2:AF9:V, PF3:AF9:V, PF4:AF9:V"
    # PF04:AF09:V, PF03:AF09:V, PF02:AF09:V, PF01:AF09:V, PF00:AF09:V, PG12:AF03:V
    # Port F: PF04:AF09:V, PF03:AF09:V, PF02:AF09:V, PF01:AF09:V, PF00:AF09:V
    mmw 0x58021400 0x000002AA 0x00000155    ;# MODER
    mmw 0x58021408 0x000003FF 0x00000000    ;# OSPEEDR
    mmw 0x5802140C 0x00000000 0x000003FF    ;# PUPDR
    mmw 0x58021420 0x00099999 0x00066666    ;# AFRL
    # Port G: PG12:AF03:V
    mmw 0x58021800 0x02000000 0x01000000    ;# MODER
    mmw 0x58021808 0x03000000 0x00000000    ;# OSPEEDR
    mmw 0x5802180C 0x00000000 0x03000000    ;# PUPDR
    mmw 0x58021824 0x00030000 0x000C0000    ;# AFRH
	
	
	# OCTOSPI1: memory-mapped 1-line read mode with 4-byte addresses
	mww 0x5200A130 0x00001000				;# OCTOSPI_LPTR: deactivate CS after 4096 clocks when FIFO is full
	mww 0x5200A000 0x3040000B				;# OCTOSPI_CR: FMODE=0x1, APMS=1, FTHRES=0, FSEL=0, DQM=0, TCEN=0
	mww 0x5200A008 0x01190100				;# OCTOSPI_DCR1: MTYP=0x1, FSIZE=0x19, CSHT=0x01, CKMODE=0, DLYBYP=0
	mww 0x5200A00C 0x00000005				;# OCTOSPI_DCR2: PRESCALER=5

	mww 0x5200A108 0x00000000				;# OCTOSPI_TCR: SSHIFT=0, DHQC=0, DCYC=0x0
	mww 0x5200A100 0x01012101				;# OCTOSPI_CCR: DMODE=0x1, ABMODE=0x0, ADSIZE=0x3, ADMODE=0x1, ISIZE=0x0, IMODE=0x1
	mww 0x5200A110 0x00000013				;# OCTOSPI_IR: INSTR=READ4B
	
	
}

$_CHIPNAME.cpu0 configure -event reset-init {
	global OCTOSPI1
	global OCTOSPI2

	mmw 0x52002000 0x00000004 0x0000000B	;# FLASH_ACR: 4 WS for 192 MHZ HCLK

	mmw 0x58024400 0x00000001 0x00000018	;# RCC_CR: HSIDIV=1, HSI on
	mmw 0x58024410 0x10000000 0xEE000007	;# RCC_CFGR: MCO2=system, MCO2PRE=8, HSI as system clock
	mww 0x58024418 0x00000040				;# RCC_D1CFGR: D1CPRE=1, D1PPRE=2, HPRE=1
	mww 0x5802441C 0x00000440				;# RCC_D2CFGR: D2PPRE2=2, D2PPRE1=2
	mww 0x58024420 0x00000040				;# RCC_D3CFGR: D3PPRE=2
	mww 0x58024428 0x00000040				;# RCC_PPLCKSELR: DIVM3=0, DIVM2=0, DIVM1=4, PLLSRC=HSI
	mmw 0x5802442C 0x0001000C 0x00000002	;# RCC_PLLCFGR: PLL1RGE=8MHz to 16MHz, PLL1VCOSEL=wide
	mww 0x58024430 0x01070217				;# RCC_PLL1DIVR: 192 MHz: DIVR1=2, DIVQ=8, DIVP1=2, DIVN1=24
	mmw 0x58024400 0x01000000 0				;# RCC_CR: PLL1ON=1
	sleep 1
	mmw 0x58024410 0x00000003 0				;# RCC_CFGR: PLL1 as system clock
	sleep 1

	adapter speed 24000

	if { $OCTOSPI2 } {
		octospi_init 1
	}
}